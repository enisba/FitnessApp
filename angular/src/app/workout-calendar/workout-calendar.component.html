<div class="calendar-wrapper container mt-4">
  <div class="header">
    <h2>Workout Calendar</h2>
    <div class="right">
      <button nz-button nzType="default" (click)="goPrev()">‹ Prev</button>
      <div class="month-label">{{ monthLabel() }}</div>
      <button nz-button nzType="default" (click)="goNext()">Next ›</button>
      <button nz-button nzType="primary" (click)="openToday()" class="add-btn">+ Add</button>
    </div>
  </div>

  <!-- SADE: önce takvimi kesin gösterelim -->
  <nz-calendar
    [nzMode]="'month'"
    [nzValue]="viewDate()"
    (nzValueChange)="onMonthChanged($event)">

    <!-- Hücre şablonunu İÇERİDE directive ile ver -->
    <ng-template nzDateFullCell let-current>
      <div class="date-cell" (click)="onSelect(current)">
        <div class="date-num">{{ current.getDate() }}</div>

        <div class="badges" *ngIf="logsOf(current).length">
          <div class="badge"
               *ngFor="let l of top3(current); trackBy: trackById"
               [ngClass]="{ workout: l.type===0, exercise: l.type===1 }">
            {{ l.type===0 ? (l.workoutName || 'Workout') : (l.exerciseName || 'Exercise') }}
          </div>
          <div class="more" *ngIf="logsOf(current).length > 3">+{{ logsOf(current).length - 3 }}</div>
        </div>
      </div>
    </ng-template>

  </nz-calendar>
</div>

<nz-modal
  [nzVisible]="modalVisible()"
  (nzVisibleChange)="onVisibleChange($event)"
  [nzTitle]="modalTitle()"
  [nzCentered]="true"
  [nzWidth]="680"
  [nzFooter]="null"
  [nzMaskClosable]="false"
  (nzOnCancel)="closeModal()">

  <ng-container *nzModalContent>
    <div class="existing" *ngIf="logsOf(selectedDate()).length">
      <div class="ex-title">Existing logs</div>
      <ul class="ex-list">
        <li *ngFor="let l of logsOf(selectedDate()); trackBy: trackById">
          <span class="tag" [ngClass]="{ workout: l.type===0, exercise: l.type===1 }">
            {{ l.type===0 ? (l.workoutName || 'Workout') : (l.exerciseName || 'Exercise') }}
          </span>
          <span class="muted" *ngIf="l.sets && l.reps">{{ l.sets }}&times;{{ l.reps }}</span>
          <span class="muted" *ngIf="l.weight">• {{ l.weight }} kg</span>
          <span class="muted" *ngIf="l.durationMinutes">• {{ l.durationMinutes }} min</span>
          <button nz-button nzType="link" (click)="removeLog(l.id!)">Delete</button>
        </li>
      </ul>
      <hr />
    </div>

    <form [formGroup]="form" (ngSubmit)="save()" autocomplete="off" class="form-grid">

      <!-- Tip seçimi -->
      <div class="row">
        <label class="lbl">Type</label>
        <nz-radio-group formControlName="type">
          <label nz-radio nzValue="workout">Workout</label>
          <label nz-radio nzValue="exercise">Exercise</label>
        </nz-radio-group>
      </div>

      <!-- Workout modu: SADECE workout seçimi -->
      <div class="row" *ngIf="form.value.type==='workout'">
        <label class="lbl">Workout</label>
        <nz-select formControlName="workoutId" nzShowSearch nzPlaceHolder="Select workout" class="w-100">
          <nz-option *ngFor="let w of workouts()" [nzValue]="w.id" [nzLabel]="w.name"></nz-option>
        </nz-select>
      </div>

      <!-- Exercise modu: exercise seçimi + (sets/reps/weight + duration) -->
      <div class="row" *ngIf="form.value.type==='exercise'">
        <label class="lbl">Exercise</label>
        <nz-select formControlName="exerciseId" nzShowSearch nzPlaceHolder="Select exercise" class="w-100">
          <nz-option *ngFor="let e of exercises()" [nzValue]="e.id" [nzLabel]="e.name"></nz-option>
        </nz-select>
      </div>

      <!-- Sadece EXERCISE iken görünsün -->
      <div class="row three" *ngIf="form.value.type==='exercise'">
        <div>
          <label class="lbl">Sets</label>
          <input nz-input type="number" formControlName="sets" placeholder="e.g., 4" />
        </div>
        <div>
          <label class="lbl">Reps</label>
          <input nz-input type="number" formControlName="reps" placeholder="e.g., 10" />
        </div>
        <div>
          <label class="lbl">Weight (kg)</label>
          <input nz-input type="number" formControlName="weight" placeholder="e.g., 60" />
        </div>
      </div>

      <!-- Sadece EXERCISE iken görünsün -->
      <div class="row two" *ngIf="form.value.type==='exercise'">
        <div>
          <label class="lbl">Duration (min)</label>
          <input nz-input type="number" formControlName="durationMinutes" placeholder="e.g., 45" />
        </div>
        <div></div>
      </div>

      <!-- NOTES: her iki modda da görünsün (opsiyonel) -->
      <div class="row">
        <label class="lbl">Notes</label>
        <input nz-input type="text" formControlName="notes" placeholder="Optional note" />
      </div>

      <div class="footer">
        <button nz-button type="button" (click)="closeModal()">Cancel</button>
        <button nz-button nzType="primary" type="submit" [disabled]="saving()">Save</button>
      </div>
    </form>
  </ng-container>
</nz-modal>
