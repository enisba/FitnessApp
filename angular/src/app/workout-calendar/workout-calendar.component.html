<div class="calendar-wrapper container mt-4">
  <div class="header">
<h2>{{ 'CALENDAR.TITLE' | translate }}</h2>
    <div class="right">
<button nz-button nzType="default" (click)="goPrev()">‹ {{ 'CALENDAR.PREV' | translate }}</button>
<div class="month-label">{{ monthLabel() }}</div>
<button nz-button nzType="default" (click)="goNext()">{{ 'CALENDAR.NEXT' | translate }} ›</button>
<button nz-button nzType="primary" (click)="openToday()" class="add-btn">+ {{ 'CALENDAR.ADD' | translate }}</button>

    </div>
  </div>

  <ng-template #fullCell let-current>
    <div class="date-cell" (click)="onSelect(current)">
      <div class="date-num">{{ current.getDate() }}</div>

      <div class="badges" *ngIf="logsOf(current).length">
        <div class="badge"
             *ngFor="let l of top3(current); trackBy: trackById"
             [ngClass]="{ workout: l.type===0, exercise: l.type===1 }">
          {{ l.type===0 ? (l.workoutName || 'Workout') : (l.exerciseName || 'Exercise') }}
        </div>
        <div class="more" *ngIf="logsOf(current).length > 3">+{{ logsOf(current).length - 3 }}</div>
      </div>
    </div>
  </ng-template>

  <nz-calendar
    [nzMode]="'month'"
    [nzValue]="viewDate()"
    (nzValueChange)="onMonthChanged($event)"
    [nzDateFullCell]="fullCell">
  </nz-calendar>
</div>

<nz-modal
  [nzVisible]="modalVisible()"
  (nzVisibleChange)="onVisibleChange($event)"
  [nzTitle]="modalTitle()"
  [nzCentered]="true"
  [nzWidth]="680"
  [nzFooter]="null"
  [nzMaskClosable]="false"
  (nzOnCancel)="closeModal()">

  <ng-container *nzModalContent>
    <div class="existing" *ngIf="logsOf(selectedDate()).length">
<div class="ex-title">{{ 'CALENDAR.EXISTING_LOGS' | translate }}</div>
      <ul class="ex-list">
        <li *ngFor="let l of logsOf(selectedDate()); trackBy: trackById">
          <span class="tag" [ngClass]="{ workout: l.type===0, exercise: l.type===1 }">
            {{ l.type===0 ? (l.workoutName || 'Workout') : (l.exerciseName || 'Exercise') }}
          </span>
          <span class="muted" *ngIf="l.sets && l.reps">{{ l.sets }}&times;{{ l.reps }}</span>
          <span class="muted" *ngIf="l.weight">• {{ l.weight }} kg</span>
          <span class="muted" *ngIf="l.durationMinutes">• {{ l.durationMinutes }} min</span>
<button nz-button nzType="link" (click)="removeLog(l.id!)">{{ 'CALENDAR.DELETE' | translate }}</button>
        </li>
      </ul>
      <hr>
    </div>

    <form [formGroup]="form" (ngSubmit)="save()" autocomplete="off" class="form-grid">
      <div class="row">
<label class="lbl">{{ 'CALENDAR.TYPE' | translate }}</label>
        <nz-radio-group formControlName="type">
<label nz-radio nzValue="workout">{{ 'CALENDAR.WORKOUT' | translate }}</label>
<label nz-radio nzValue="exercise">{{ 'CALENDAR.EXERCISE' | translate }}</label>
        </nz-radio-group>
      </div>

      <div class="row" *ngIf="form.value.type==='workout'">
<label class="lbl">{{ 'CALENDAR.WORKOUT' | translate }}</label>
<nz-select formControlName="workoutId" nzShowSearch nzPlaceHolder="{{ 'CALENDAR.SELECT_WORKOUT' | translate }}" class="w-100">
          <nz-option *ngFor="let w of workouts()" [nzValue]="w.id" [nzLabel]="w.name"></nz-option>
        </nz-select>
      </div>

      <div class="row" *ngIf="form.value.type==='exercise'">
<label class="lbl">{{ 'CALENDAR.EXERCISE' | translate }}</label>
<nz-select formControlName="exerciseId" nzShowSearch nzPlaceHolder="{{ 'CALENDAR.SELECT_EXERCISE' | translate }}" class="w-100">
          <nz-option *ngFor="let e of exercises()" [nzValue]="e.id" [nzLabel]="e.name"></nz-option>
        </nz-select>
      </div>

<div class="row" *ngIf="form.value.type==='workout'">
<label class="lbl">{{ 'CALENDAR.NOTES' | translate }}</label>
<input nz-input type="text" formControlName="notes" placeholder="{{ 'CALENDAR.OPTIONAL_NOTE' | translate }}">

</div>

<div *ngIf="form.value.type==='exercise'">
  <div class="row three">
    <div>
<label class="lbl">{{ 'CALENDAR.SETS' | translate }}</label>
<input nz-input type="number" formControlName="sets" placeholder="e.g., 4">
    </div>
    <div>
<label class="lbl">{{ 'CALENDAR.REPS' | translate }}</label>
<input nz-input type="number" formControlName="reps" placeholder="e.g., 10">
    </div>
    <div>
<label class="lbl">{{ 'CALENDAR.WEIGHT' | translate }}</label>
<input nz-input type="number" formControlName="weight" placeholder="e.g., 60">
    </div>
  </div>

  <div class="row two">
    <div>
<label class="lbl">{{ 'CALENDAR.DURATION' | translate }}</label>
<input nz-input type="number" formControlName="durationMinutes" placeholder="e.g., 45">
    </div>
    <div>
      <label class="lbl">Notes</label>
      <input nz-input type="text" formControlName="notes" placeholder="Optional note">
    </div>
  </div>
</div>

      <div class="footer">
<div class="footer">
  <button nz-button type="button" (click)="closeModal()">{{ 'CALENDAR.CANCEL' | translate }}</button>
  <button nz-button nzType="primary" type="submit" [disabled]="saving()">{{ 'CALENDAR.SAVE' | translate }}</button>
</div>
      </div>
    </form>
  </ng-container>
</nz-modal>
