<!-- ÜST BAR -->
<form [formGroup]="searchForm" class="toolbar">
  <!-- Search (solda, genişler) -->
  <nz-input-group nzPrefixIcon="search" class="grow">
<input nz-input formControlName="q" placeholder="{{ 'EXERCISE.SEARCH' | translate }}" />
  </nz-input-group>

  <!-- Difficulty -->
<nz-select class="w-100" formControlName="difficulty" nzAllowClear nzPlaceHolder="{{ 'EXERCISE.DIFFICULTY' | translate }}">
  <nz-option [nzValue]="0" [nzLabel]="'EXERCISE.EASY' | translate"></nz-option>
  <nz-option [nzValue]="1" [nzLabel]="'EXERCISE.MEDIUM' | translate"></nz-option>
  <nz-option [nzValue]="2" [nzLabel]="'EXERCISE.HARD' | translate"></nz-option>
</nz-select>

  <!-- Muscle -->
<nz-select class="w-100" formControlName="muscleId" nzAllowClear nzPlaceHolder="{{ 'EXERCISE.MUSCLE' | translate }}">
    <nz-option *ngFor="let m of muscles" [nzValue]="m.id" [nzLabel]="m.name"></nz-option>
  </nz-select>

  <!-- Aktif filtreleri tek tıkla temizle -->
<button type="button" class="btn btn-link toolbar-reset" (click)="resetFilters()" *ngIf="activeBadges.length">
  {{ 'EXERCISE.CLEAR' | translate }}
</button>
  <!-- Spacer -->
  <span class="spacer"></span>

<button class="btn btn-primary" type="button" (click)="openCreate()">
  <i class="bi bi-plus-lg"></i> {{ 'EXERCISE.NEW' | translate }}
</button>
</form>

<!-- Aktif filtre rozetleri -->
<div class="active-filters" *ngIf="activeBadges.length">
  <span class="badge bg-secondary-subtle text-body-secondary" *ngFor="let b of activeBadges">{{ b }}</span>
</div>

<!-- Sonuç sayısı -->
<div class="results-hint" *ngIf="!loading">
  {{ exercises.length }} {{ exercises.length===1 ? ('EXERCISE.RESULT' | translate) : ('EXERCISE.RESULTS' | translate) }}
</div>
<!-- TABLO -->
<div *ngIf="loading">Loading...</div>
<table class="table table-hover modern-table" *ngIf="!loading && exercises.length">
  <thead>
    <tr>
<th>{{ 'EXERCISE.NAME' | translate }}</th>
<th>{{ 'EXERCISE.PRIMARY_MUSCLE' | translate }}</th>
<th>{{ 'EXERCISE.DIFFICULTY' | translate }}</th>
<th class="text-end">{{ 'EXERCISE.ACTIONS' | translate }}</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let ex of exercises; trackBy: trackById">
      <td class="name-cell">{{ ex.name }}</td>
      <td>{{ ex.primaryMuscleName }}</td>
      <td>
        <span class="chip" [ngClass]="difficultyMap[ex.difficulty].class">
          {{ difficultyMap[ex.difficulty].text }}
        </span>
      </td>
      <td class="text-end">
<button class="btn btn-sm btn-outline-primary me-2" (click)="openEdit(ex)">{{ 'EXERCISE.EDIT' | translate }}</button>
<button class="btn btn-sm btn-outline-danger" (click)="delete(ex.id)">{{ 'EXERCISE.DELETE' | translate }}</button>

      </td>
    </tr>
  </tbody>
</table>

<div class="empty" *ngIf="!loading && !exercises.length">
  <i class="bi bi-emoji-neutral"></i>
  <div>{{ 'EXERCISE.EMPTY' | translate }}</div>
</div>

<!-- UPSERT MODAL (ADD + EDIT) -->
<nz-modal
  [(nzVisible)]="upsertVisible"
[nzTitle]="mode==='create' ? ('EXERCISE.NEW' | translate) : ('EXERCISE.EDIT' | translate)"
  [nzCentered]="true"
  [nzWidth]="640"
  nzWrapClassName="centered-modal"
  [nzFooter]="null"
  [nzMaskClosable]="false"
  (nzOnCancel)="upsertVisible=false">

  <!-- KRİTİK: içerik *nzModalContent ile sarmalanır -->
  <ng-container *nzModalContent>
    <form [formGroup]="upsertForm" (ngSubmit)="saveUpsert()" class="modal-form">
      <div class="modal-grid">
        <div>
<label class="form-label">{{ 'EXERCISE.NAME' | translate }}</label>
          <nz-input-group nzPrefixIcon="edit">
            <input nz-input formControlName="name" cdkFocusInitial placeholder="Incline Dumbbell Press" />
          </nz-input-group>
          <small class="text-danger" *ngIf="upsertForm.controls.name.touched && upsertForm.controls.name.invalid">Required</small>
        </div>

        <div>
<label class="form-label">{{ 'EXERCISE.PRIMARY_MUSCLE' | translate }}</label>
          <nz-select formControlName="primaryMuscleId" nzShowSearch nzPlaceHolder="Select muscle" class="w-100">
            <nz-option *ngFor="let m of muscles" [nzValue]="m.id" [nzLabel]="m.name"></nz-option>
          </nz-select>
          <small class="text-danger" *ngIf="upsertForm.controls.primaryMuscleId.touched && upsertForm.controls.primaryMuscleId.invalid">Required</small>
        </div>
      </div>

      <div>
<div class="form-label">{{ 'EXERCISE.DIFFICULTY' | translate }}</div>
        <div class="btn-group diff-group" role="group" aria-label="Difficulty">
          <input type="radio" class="btn-check" name="diff" id="diff-easy" (change)="setDiff(0)" [checked]="upsertForm.value.difficulty===0">
<label class="btn btn-outline-success" for="diff-easy">{{ 'EXERCISE.EASY' | translate }}</label>

          <input type="radio" class="btn-check" name="diff" id="diff-med" (change)="setDiff(1)" [checked]="upsertForm.value.difficulty===1">
<label class="btn btn-outline-warning" for="diff-med">{{ 'EXERCISE.MEDIUM' | translate }}</label>

          <input type="radio" class="btn-check" name="diff" id="diff-hard" (change)="setDiff(2)" [checked]="upsertForm.value.difficulty===2">
<label class="btn btn-outline-danger" for="diff-hard">{{ 'EXERCISE.HARD' | translate }}</label>
        </div>
      </div>

      <div class="footer">
<button type="button" class="btn btn-light" (click)="upsertVisible=false">{{ 'EXERCISE.CANCEL' | translate }}</button>
        <button type="submit" class="btn btn-primary" [disabled]="upsertForm.invalid || saving">
<span *ngIf="!saving">{{ mode==='create' ? ('EXERCISE.CREATE' | translate) : ('EXERCISE.SAVE' | translate) }}</span>
<span *ngIf="saving">{{ 'EXERCISE.SAVING' | translate }}</span>
        </button>
      </div>
    </form>
  </ng-container>
</nz-modal>
